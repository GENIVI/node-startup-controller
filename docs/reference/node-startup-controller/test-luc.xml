<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN"
                          "http://www.oasis-open.org/docbook/xml/4.1.2/docbookx.dtd" [
]>

<refentry id="test-luc">
  <refmeta>
    <refentrytitle>Last User Context handling</refentrytitle>
  </refmeta>

  <refnamediv>
    <refname>luc handling</refname>
    <refpurpose>
      Testing that the Node Startup Controller(NSC) correctly sets the Last User Context (LUC),
    and starts the apps correctly on NSC startup.
    </refpurpose>
  </refnamediv>

  <refsection>
    <title>Test environment and setup</title>
    <refsection>
      <title>GDBus</title>
      <para>
        This test assumes that the <command>gdbus</command> programme is installed on the
        system. Without this programme, this test is impossible.
      </para>
    </refsection>

    <refsection>
      <title>Helpful functions</title>
      <para>
        gdbus functions will be used frequently. To avoid excessive typing, the following
        functions should be defined and called:
        <programlisting>
          # function to begin registration
          begin()
          {
            gdbus call --system \
              -d org.genivi.NodeStartupController1 \
              -o /org/genivi/NodeStartupController1/NodeStartupController \
              -m org.genivi.NodeStartupController1.NodeStartupController.BeginLUCRegistration \
          }

          # function to make a registration call
          register()
          {
            gdbus call --system \
              -d org.genivi.NodeStartupController1 \
              -o /org/genivi/NodeStartupController1/NodeStartupController \
              -m org.genivi.NodeStartupController1.NodeStartupController.RegisterWithLUC \
              "$1"
          }

          # function to finish registration
          end()
          {
            gdbus call --system \
              -d org.genivi.NodeStartupController1 \
              -o /org/genivi/NodeStartupController1/NodeStartupController \
              -m org.genivi.NodeStartupController1.NodeStartupController.FinishLUCRegistration \
          }
        </programlisting>
      </para>
    </refsection>

  </refsection>

  <refsection>
    <title>Test Overview</title>
    <para>
      The following behaviours will be confirmed:
      <itemizedlist>
        <listitem><para><xref linkend="test-luc-register-simple" endterm="test-luc-register-simple-title" /></para></listitem>
        <listitem><para><xref linkend="test-luc-register-only" endterm="test-luc-register-only-title" /></para></listitem>
        <listitem><para><xref linkend="test-luc-finish-only" endterm="test-luc-finish-only-title" /></para></listitem>
        <listitem><para><xref linkend="test-luc-register-complex" endterm="test-luc-register-complex-title" /></para></listitem>
        <listitem><para><xref linkend="test-luc-register-series" endterm="test-luc-register-series-title" /></para></listitem>
        <listitem><para><xref linkend="tests-luc-register-series-reorder" endterm="tests-luc-register-series-reorder-title" /></para></listitem>
      </itemizedlist>
    </para>
  </refsection>

  <refsection>
    <title>Test cases</title>
    <refsection>
      <orderedlist>
        <listitem><programlisting>systemctl start nsm-dummy.service</programlisting></listitem>
        <listitem><programlisting>systemctl start node-startup-controller.service</programlisting></listitem>
      </orderedlist>
    </refsection>
    <refsection id="test-luc-register-simple">
      <title id="test-luc-register-simple-title">Registration of a simple dictionary</title>
      <orderedlist continuation="continues">
        <listitem><programlisting>begin</programlisting></listitem>
        <listitem><programlisting>register "{0: ['app1.unit']}"</programlisting></listitem>
        <listitem><programlisting>end</programlisting></listitem>
        <listitem>
          Read the DLT log and verify this entry appears:
          <informaltable><tgroup cols="3">
            <thead>
              <row> <entry>APID</entry> <entry>CTID</entry> <entry>Payload</entry> </row>
            </thead>
            <tbody>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[The new context is: "{0: ['app1.unit']}"]</entry></row>
            </tbody>
          </tgroup></informaltable>
        </listitem>
        <listitem><programlisting>systemctl restart node-startup-controller.service</programlisting></listitem>
        <note>
          If the following entry is seen:
            <informaltable><tgroup cols="3">
              <thead>
                <row> <entry>APID</entry> <entry>CTID</entry> <entry>Payload</entry> </row>
              </thead>
              <tbody>
                <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[LUC is not required]</entry></row>
              </tbody>
            </tgroup></informaltable>
          perform the following command line again:
          <programlisting>systemctl restart node-startup-controller.service</programlisting>
          </note>
        <listitem>
          Read the DLT log and verify these entries appear:
          <informaltable><tgroup cols="3">
            <thead>
              <row> <entry>APID</entry> <entry>CTID</entry> <entry>Payload</entry> </row>
            </thead>
            <tbody>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start group 0]</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start app 'app1.unit']</entry></row>
            </tbody>
          </tgroup></informaltable>
        </listitem>
      </orderedlist>
    </refsection>
    <refsection id="test-luc-register-only">
      <title id="test-luc-register-only-title">Registration does not happen on an isolated RegisterWithLUC() call</title>
      <orderedlist continuation="continues">
        <listitem><programlisting>register "{1: ['app2.unit']}"</programlisting></listitem>
        <listitem>
          Read the DLT log and verify this entry <emphasis>doesn't</emphasis> appear:
          <informaltable><tgroup cols="3">
            <thead>
              <row> <entry>APID</entry> <entry>CTID</entry> <entry>Payload</entry> </row>
            </thead>
            <tbody>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[The new context is: "{1: ['app2.unit']}"]</entry></row>
            </tbody>
          </tgroup></informaltable>
        </listitem>
      </orderedlist>
    </refsection>
    <refsection id="tests-luc-finish-only">
      <title id="test-luc-finish-only-title">An isolated FinishLUCRegistration() call will not change the LUC</title>
      <orderedlist continuation="continues">
        <listitem><programlisting>end</programlisting></listitem>
        <listitem><programlisting>systemctl restart node-startup-controller.service</programlisting></listitem>
        <listitem>
          Read the DLT log and verify these entries appear:
          <informaltable><tgroup cols="3">
            <thead>
              <row> <entry>APID</entry> <entry>CTID</entry> <entry>Payload</entry> </row>
            </thead>
            <tbody>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start group 0]</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start app 'app1.unit']</entry></row>
            </tbody>
          </tgroup></informaltable>
        </listitem>
      </orderedlist>
    </refsection>
    <refsection id="test-luc-register-complex">
      <title id="test-luc-register-complex-title">Registration of a complex dictionary</title>
      <orderedlist continuation="continues">
        <listitem><programlisting>begin</programlisting></listitem>
        <listitem><programlisting>register "{0: ['app1.unit'], 1: ['app1.unit', 'app3.unit'], 2: ['app2.unit']}"</programlisting></listitem>
        <listitem><programlisting>end</programlisting></listitem>
        <listitem>
          Read the DLT log and verify these entries appear:
          <informaltable><tgroup cols="3">
            <thead>
              <row> <entry>APID</entry> <entry>CTID</entry> <entry>Payload</entry> </row>
            </thead>
            <tbody>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[The new context is: "{0: ['app1.unit'], 1: ['app1.unit', 'app3.unit'], 2: ['app2.unit']}"]</entry></row>
            </tbody>
          </tgroup></informaltable>
        </listitem>
        <listitem><programlisting>systemctl restart node-startup-controller.service</programlisting></listitem>
        <listitem>
          Read the DLT log and verify these entries appear:
          <informaltable><tgroup cols="3">
            <thead>
              <row> <entry>APID</entry> <entry>CTID</entry> <entry>Payload</entry> </row>
            </thead>
            <tbody>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start group 0]</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start app 'app1.unit']</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start group 1]</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start app 'app1.unit']</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start app 'app3.unit']</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start group 2]</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start app 'app2.unit']</entry></row>
            </tbody>
          </tgroup></informaltable>
        </listitem>
      </orderedlist>
    </refsection>
    <refsection id="test-luc-register-series">
      <title id="test-luc-register-series-title">Registration can happen with a series of RegisterWithLUC() calls</title>
      <orderedlist continuation="continues">
        <listitem><programlisting>begin</programlisting></listitem>
        <listitem><programlisting>register "{0: ['app1.unit']}"</programlisting></listitem>
        <listitem><programlisting>register "{1: ['app3.unit']}"</programlisting></listitem>
        <listitem><programlisting>end</programlisting></listitem>
        <listitem>
          Read the DLT log and verify these entries appear:
          <informaltable><tgroup cols="3">
            <thead>
              <row> <entry>APID</entry> <entry>CTID</entry> <entry>Payload</entry> </row>
            </thead>
            <tbody>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[The new context is: "{0: ['app1.unit']}"]</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[The new context is: "{0: ['app1.unit'], 1: ['app3.unit']}"]</entry></row>
            </tbody>
          </tgroup></informaltable>
        </listitem>
        <listitem><programlisting>systemctl restart node-startup-controller.service</programlisting></listitem>
        <listitem>
          Read the DLT log and verify these entries appear:
          <informaltable><tgroup cols="3">
            <thead>
              <row> <entry>APID</entry> <entry>CTID</entry> <entry>Payload</entry> </row>
            </thead>
            <tbody>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start group 0]</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start app 'app1.unit']</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start group 1]</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start app 'app3.unit']</entry></row>
            </tbody>
          </tgroup></informaltable>
        </listitem>
      </orderedlist>
    </refsection>
    <refsection id="tests-luc-register-series-reorder">
      <title id="tests-luc-register-series-reorder-title">Repeated registration of an app changes the order in the LUC</title>
      <orderedlist continuation="continues">
        <listitem><programlisting>begin</programlisting></listitem>
        <listitem><programlisting>register "{1: ['app1.unit', 'app2.unit']}"</programlisting></listitem>
        <listitem><programlisting>register "{1: ['app1.unit']}"</programlisting></listitem>
        <listitem><programlisting>end</programlisting></listitem>
        <listitem>
          Read the DLT logs and verify these entries appear:
          <informaltable><tgroup cols="3">
            <thead>
              <row> <entry>APID</entry> <entry>CTID</entry> <entry>Payload</entry> </row>
            </thead>
            <tbody>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[The new context is: "{1: ['app1.unit', 'app2.unit']}"]</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[The new context is: "{1: ['app2.unit', 'app1.unit']}"]</entry></row>
            </tbody>
          </tgroup></informaltable>
        </listitem>

        <listitem><programlisting>systemctl restart node-startup-controller.service</programlisting></listitem>
        <listitem>
          Read the DLT log and verify these entries appear:
          <informaltable><tgroup cols="3">
            <thead>
              <row> <entry>APID</entry> <entry>CTID</entry> <entry>Payload</entry> </row>
            </thead>
            <tbody>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start group 1]</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start app 'app2.unit']</entry></row>
              <row><entry>NSC-</entry> <entry>CTRL</entry> <entry>[start app 'app1.unit']</entry></row>
            </tbody>
          </tgroup></informaltable>
        </listitem>
      </orderedlist>
    </refsection>
  </refsection>
</refentry>
